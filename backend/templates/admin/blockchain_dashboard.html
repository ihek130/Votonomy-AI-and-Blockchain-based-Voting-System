{% extends "base_admin.html" %}
{% block title %}Blockchain Dashboard{% endblock %}

{% block content %}
<div class="blockchain-dashboard">
    <div class="dashboard-header">
        <h2>
            <i class="bi bi-link-45deg"></i> Blockchain Integration Dashboard
        </h2>
        <p class="text-muted">Solana Devnet - Real-time blockchain statistics</p>
    </div>

    <!-- Network Status Card -->
    <div class="alert {% if stats.network.connected %}alert-success{% else %}alert-danger{% endif %} mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>
                    {% if stats.network.connected %}
                        ✅ Connected to Solana Devnet
                    {% else %}
                        ❌ Blockchain Disconnected
                    {% endif %}
                </strong>
                <br>
                <small>{{ stats.network.network_url }}</small>
            </div>
            <div class="text-end">
                <div><strong>Current Slot:</strong> {{ "{:,}".format(stats.network.current_slot) }}</div>
                <div><strong>Admin Balance:</strong> {{ "%.4f"|format(stats.network.admin_balance) }} SOL</div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="row g-4 mb-4">
        <!-- Total Votes -->
        <div class="col-md-3">
            <div class="stat-card bg-primary text-white">
                <div class="stat-icon">
                    <i class="bi bi-database"></i>
                </div>
                <div class="stat-details">
                    <h3>{{ stats.total_votes }}</h3>
                    <p>Total Votes</p>
                </div>
            </div>
        </div>

        <!-- Blockchain Verified -->
        <div class="col-md-3">
            <div class="stat-card bg-success text-white">
                <div class="stat-icon">
                    <i class="bi bi-shield-check"></i>
                </div>
                <div class="stat-details">
                    <h3>{{ stats.blockchain_verified }}</h3>
                    <p>Blockchain Verified</p>
                </div>
            </div>
        </div>

        <!-- Pending Verification -->
        <div class="col-md-3">
            <div class="stat-card bg-warning text-white">
                <div class="stat-icon">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-details">
                    <h3>{{ stats.pending_verification }}</h3>
                    <p>Pending Verification</p>
                </div>
            </div>
        </div>

        <!-- Verification Rate -->
        <div class="col-md-3">
            <div class="stat-card bg-info text-white">
                <div class="stat-icon">
                    <i class="bi bi-percent"></i>
                </div>
                <div class="stat-details">
                    <h3>{{ "%.1f"|format(stats.verification_rate) }}%</h3>
                    <p>Verification Rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest Blockchain Vote -->
    {% if stats.latest_blockchain_vote.signature %}
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <i class="bi bi-clock-history"></i> Latest Blockchain Vote
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Position:</strong> {{ stats.latest_blockchain_vote.position }}
                </div>
                <div class="col-md-4">
                    <strong>Timestamp:</strong> {{ stats.latest_blockchain_vote.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                </div>
                <div class="col-md-4">
                    <strong>Signature:</strong> 
                    <code class="small">{{ stats.latest_blockchain_vote.signature[:16] }}...</code>
                    <a href="https://explorer.solana.com/tx/{{ stats.latest_blockchain_vote.signature }}?cluster=devnet" 
                       target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                        <i class="bi bi-box-arrow-up-right"></i> Explorer
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Blockchain Votes -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-list-check"></i> Recent Blockchain Verified Votes (Last 10)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Position</th>
                            <th>Blockchain Signature</th>
                            <th>Slot</th>
                            <th>Timestamp</th>
                            <th>Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_votes %}
                            {% for vote in recent_votes %}
                            <tr>
                                <td><span class="badge bg-secondary">{{ vote.position }}</span></td>
                                <td>
                                    <code class="small">{{ vote.blockchain_tx_signature[:20] }}...</code>
                                </td>
                                <td>{{ "{:,}".format(vote.blockchain_slot) }}</td>
                                <td>{{ vote.blockchain_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td><code class="small">{{ vote.verification_receipt }}</code></td>
                                <td>
                                    <a href="https://explorer.solana.com/tx/{{ vote.blockchain_tx_signature }}?cluster=devnet" 
                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-box-arrow-up-right"></i> Explorer
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    No blockchain-verified votes yet
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="mt-4 text-center">
        <a href="{{ url_for('admin_bp.blockchain_audit_report') }}" class="btn btn-primary">
            <i class="bi bi-file-earmark-text"></i> Generate Audit Report
        </a>
        <a href="{{ url_for('admin_bp.admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<style>
.blockchain-dashboard {
    padding: 2rem;
}

.dashboard-header {
    margin-bottom: 2rem;
}

.dashboard-header h2 {
    color: #01411C;
    font-weight: bold;
}

.stat-card {
    border-radius: 10px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 2.5rem;
    opacity: 0.8;
}

.stat-details h3 {
    font-size: 2rem;
    margin: 0;
    font-weight: bold;
}

.stat-details p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.9;
}

.card-header {
    font-weight: 600;
}

code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.85rem;
}

.table td, .table th {
    vertical-align: middle;
}
</style>
{% endblock %}
