{% extends "base_admin.html" %}
{% block title %}Blockchain Dashboard{% endblock %}

{% block content %}
<div class="blockchain-dashboard-wrapper" data-blockchain-verified="{{ stats.blockchain_verified }}">
<div class="blockchain-dashboard">
    <div class="dashboard-header">
        <h2>
            <i class="bi bi-link-45deg"></i> Blockchain Integration Dashboard
        </h2>
        <p class="text-muted">Solana Devnet - Real-time blockchain statistics</p>
    </div>

    <!-- Network Status Card -->
    <div class="alert {% if stats.network.connected %}alert-success{% else %}alert-danger{% endif %} mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>
                    {% if stats.network.connected %}
                        ‚úÖ Connected to Solana Devnet
                    {% else %}
                        ‚ùå Blockchain Disconnected
                    {% endif %}
                </strong>
                <br>
                <small>{{ stats.network.network_url }}</small>
            </div>
            <div class="text-end">
                <div><strong>Current Slot:</strong> {{ "{:,}".format(stats.network.current_slot) }}</div>
                <div><strong>Admin Balance:</strong> {{ "%.4f"|format(stats.network.admin_balance) }} SOL</div>
            </div>
        </div>
    </div>

    <!-- Integrity Check Card -->
    <div id="integrity-status-card" class="alert alert-info mb-4" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong id="integrity-status-text">
                    üîç Checking vote integrity...
                </strong>
                <br>
                <small id="integrity-details"></small>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="checkIntegrity()">
                <i class="bi bi-arrow-clockwise"></i> Recheck
            </button>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="row g-4 mb-4">
        <!-- Total Votes -->
        <div class="col-md-3">
            <div class="stat-card bg-primary text-white">
                <div class="stat-icon">
                    <i class="bi bi-database"></i>
                </div>
                <div class="stat-details">
                    <h3>{{ stats.total_votes }}</h3>
                    <p>Total Votes</p>
                </div>
            </div>
        </div>

        <!-- Blockchain Verified -->
        <div class="col-md-3">
            <div class="stat-card bg-success text-white">
                <div class="stat-icon">
                    <i class="bi bi-shield-check"></i>
                </div>
                <div class="stat-details">
                    <h3>{{ stats.blockchain_verified }}</h3>
                    <p>Blockchain Verified</p>
                </div>
            </div>
        </div>

        <!-- Pending Verification -->
        <div class="col-md-3">
            <div class="stat-card bg-warning text-white">
                <div class="stat-icon">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-details">
                    <h3>{{ stats.pending_verification }}</h3>
                    <p>Pending Verification</p>
                </div>
            </div>
        </div>

        <!-- Verification Rate -->
        <div class="col-md-3">
            <div class="stat-card bg-info text-white">
                <div class="stat-icon">
                    <i class="bi bi-percent"></i>
                </div>
                <div class="stat-details">
                    <h3>{{ "%.1f"|format(stats.verification_rate) }}%</h3>
                    <p>Verification Rate</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest Blockchain Vote -->
    {% if stats.latest_blockchain_vote.signature %}
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <i class="bi bi-clock-history"></i> Latest Blockchain Vote
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Position:</strong> {{ stats.latest_blockchain_vote.position }}
                </div>
                <div class="col-md-4">
                    <strong>Timestamp:</strong> {{ stats.latest_blockchain_vote.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                </div>
                <div class="col-md-4">
                    <strong>Signature:</strong> 
                    <code class="small">{{ stats.latest_blockchain_vote.signature[:16] }}...</code>
                    <a href="https://explorer.solana.com/tx/{{ stats.latest_blockchain_vote.signature }}?cluster=devnet" 
                       target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                        <i class="bi bi-box-arrow-up-right"></i> Explorer
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Blockchain Votes -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-list-check"></i> Recent Blockchain Verified Votes (Last 10)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Position</th>
                            <th>Blockchain Signature</th>
                            <th>Slot</th>
                            <th>Timestamp</th>
                            <th>Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_votes %}
                            {% for vote in recent_votes %}
                            <tr>
                                <td><span class="badge bg-secondary">{{ vote.position }}</span></td>
                                <td>
                                    <code class="small">{{ vote.blockchain_tx_signature[:20] }}...</code>
                                </td>
                                <td>{{ "{:,}".format(vote.blockchain_slot) }}</td>
                                <td>{{ vote.blockchain_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td><code class="small">{{ vote.verification_receipt }}</code></td>
                                <td>
                                    <a href="https://explorer.solana.com/tx/{{ vote.blockchain_tx_signature }}?cluster=devnet" 
                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-box-arrow-up-right"></i> Explorer
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    No blockchain-verified votes yet
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="mt-4 text-center">
        <button class="btn btn-success" onclick="checkIntegrity()">
            <i class="bi bi-shield-check"></i> Verify Vote Integrity
        </button>
        <a href="{{ url_for('admin_bp.blockchain_audit_report') }}" class="btn btn-primary">
            <i class="bi bi-file-earmark-text"></i> Generate Audit Report
        </a>
        <a href="{{ url_for('admin_bp.admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
</div>

<script>
// Auto-check integrity on page load if there are blockchain votes
window.addEventListener('DOMContentLoaded', function() {
    const wrapper = document.querySelector('.blockchain-dashboard-wrapper');
    const blockchainVerified = parseInt(wrapper.getAttribute('data-blockchain-verified'));
    if (blockchainVerified > 0) {
        checkIntegrity();
    }
});

function checkIntegrity() {
    const statusCard = document.getElementById('integrity-status-card');
    const statusText = document.getElementById('integrity-status-text');
    const statusDetails = document.getElementById('integrity-details');
    
    // Show loading state
    statusCard.style.display = 'block';
    statusCard.className = 'alert alert-info mb-4';
    statusText.innerHTML = 'üîç Checking vote integrity against blockchain...';
    statusDetails.innerHTML = 'This may take a moment...';
    
    // Fetch integrity check
    fetch('{{ url_for("admin_bp.blockchain_integrity_check") }}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusCard.className = 'alert alert-danger mb-4';
                statusText.innerHTML = '‚ùå Integrity Check Error';
                statusDetails.innerHTML = data.error;
                return;
            }
            
            const status = data.integrity_status;
            
            if (status === 'VERIFIED_SECURE') {
                statusCard.className = 'alert alert-success mb-4';
                statusText.innerHTML = '‚úÖ SYSTEM SECURE - No Tampering Detected';
                statusDetails.innerHTML = `Checked ${data.total_checked} votes. All ${data.verified_intact} votes match blockchain records.`;
            } else if (status === 'COMPROMISED') {
                statusCard.className = 'alert alert-danger mb-4';
                statusText.innerHTML = 'üö® CRITICAL: VOTE TAMPERING DETECTED!';
                statusDetails.innerHTML = `${data.tampering_detected} tampered votes found! Database has been modified. Check console for details.`;
                console.error('Tampered votes:', data.tampered_votes);
                
                // Show tampered votes
                if (data.tampered_votes && data.tampered_votes.length > 0) {
                    let tamperedHtml = '<div class="mt-3"><strong>Tampered Votes:</strong><ul>';
                    data.tampered_votes.forEach(vote => {
                        tamperedHtml += `<li>Vote ID ${vote.vote_id}: ${vote.position} (${vote.issue})</li>`;
                    });
                    tamperedHtml += '</ul></div>';
                    statusDetails.innerHTML += tamperedHtml;
                }
            } else if (status === 'PARTIAL_VERIFICATION') {
                statusCard.className = 'alert alert-warning mb-4';
                statusText.innerHTML = '‚ö†Ô∏è Partial Verification';
                statusDetails.innerHTML = `Verified ${data.verified_intact}/${data.total_checked} votes. ${data.unable_to_verify} could not be checked.`;
            }
        })
        .catch(error => {
            statusCard.className = 'alert alert-danger mb-4';
            statusText.innerHTML = '‚ùå Connection Error';
            statusDetails.innerHTML = 'Failed to check integrity: ' + error.message;
        });
}
</script>

<style>
.blockchain-dashboard {
    padding: 2rem;
}

.dashboard-header {
    margin-bottom: 2rem;
}

.dashboard-header h2 {
    color: #01411C;
    font-weight: bold;
}

.stat-card {
    border-radius: 10px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 2.5rem;
    opacity: 0.8;
}

.stat-details h3 {
    font-size: 2rem;
    margin: 0;
    font-weight: bold;
}

.stat-details p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.9;
}

.card-header {
    font-weight: 600;
}

code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.85rem;
}

.table td, .table th {
    vertical-align: middle;
}

.blockchain-dashboard-wrapper {
    padding: 1.5rem;
    height: calc(100vh - 80px);
    overflow-y: auto;
}

.blockchain-dashboard-wrapper::-webkit-scrollbar {
    width: 14px;
}

.blockchain-dashboard-wrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.blockchain-dashboard-wrapper::-webkit-scrollbar-thumb {
    background: #01411C;
    border-radius: 10px;
}

.blockchain-dashboard-wrapper::-webkit-scrollbar-thumb:hover {
    background: #026125;
}
</style>
{% endblock %}
